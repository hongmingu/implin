<!DOCTYPE html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Demo</title>
    {% include 'others/header_static.html' %}
    {% include 'others/favicon.html' %}

    {% load static from staticfiles %}
    <script src="{% static 'js/navbar.js' %}"></script>
    <script src="{% static 'js/a_selected.js' %}"></script>
    <script src="{% static 'js/nav_badge.js' %}"></script>

    <link href="https://fonts.googleapis.com/css?family=Tauri" rel="stylesheet">
    {% if user.is_authenticated %}
    {% else %}
    {% endif %}

</head>
<body class="light_background_color height_100">
{% include 'baseapp/_navbar.html' %}

{% include 'others/bootstrap_tester.html' %}
<!--이거 제대로 작동 안 한다 확인해야 한다.-->
{% if user.is_authenticated %}
    <div class="hidden" id="user_id">{{ user.username }}</div>
{% else %}
    <div class="hidden" id="user_id"></div>
{% endif %}
    <div class="hidden" id="group_id">{{ id }}</div>

<div class="container-fluid margin_top_50">
    <div class="row">
        <div class="col-xs-12 col-sm-offset-3 col-sm-6 col-md-offset-4 col-md-4">
            <div class="row" id="content">
                <div class="row div_base">
                    <div align="center">
                        <img class="create_post_img" id="create_post_img" src="">
                    </div>
                    <br>
                    <div class="create_post_name" id="create_post_name" align="center"></div>
                    <br>
                    <div>
                        <textarea class="create_post_textarea" id="create_post_textarea" maxlength="5000" placeholder="what you say"></textarea>
                    </div>
                    <br>
                    <div class="create_post_current">You have <span class="create_post_current_wallet" id="create_post_current_wallet"></span> $</div>
                    <div align="right"><a href="/pay/start/" target="_blank" rel="noopener noreferrer"><span class="create_post_wanna_charge clickable">want to charge?</span></a></div>
                    <div>
                        <input class="create_post_input" id="create_post_input" pattern="^\d*(\.\d{0,2})?$" placeholder="How much? ex) 12.00, 12, 1 or 1.02 ..."/>
                    </div>
                    <div class="create_post_note_wrapper">
                        <div class="create_post_note" id="create_post_note"></div>
                    </div>
                    <br>
                    <div class="create_post_before">Although you want to register on date: 2018-12-24,
                        if you register it at (for example) 2018-12-24, 23:59:59, It can be registered at 2018-12-25.
                        It is resulted from data transfer difference. So you should be aware about it. Server Time is standard.</div>
                    <div align="right"><a href=""><span class="create_post_check_server_time clickable" id="check_server_time">check current server time?</span></a></div>

                    <div class="create_post_server_time" align="right" id="server_time">
                    </div>
                    <a href=""><div class="create_post_complete clickable" id="create_post_complete" align="center">complete</div></a>
                </div>
            </div>
        </div>
    </div>
</div>

</body>


<script>
$(document).on('keydown', 'input[pattern]', function(e){
  var input = $(this);
  var oldVal = input.val();
  var regex = new RegExp(input.attr('pattern'), 'g');

  setTimeout(function(){
    var newVal = input.val();
    if(!regex.test(newVal)){
      input.val(oldVal);
    }
  }, 0);
});
</script>
<script>
    $(function () {
        $('#check_server_time').click(function (e) {
            e.preventDefault()
            $.ajax({
                url:'/re/create/check/server/time/', type:'post', dataType:'json', cache:false,
                data:{
                },
                success:function (data) {
                    if (data.res === 1){
                        var cal_value = data.time
                        var year, month, day, hour, min, sec
                        [day, time] = cal_value.split("T");
                        [year, month, day] = day.split("-");
                        [hour, min, sec] = time.split(".")[0].split(":");
                        var made_str = year + '-' + month + '-' + day + ' ' + hour + ':' + min + ':' + sec
                        $('#server_time').html(made_str)
                    }
                }
            });
        })
        $('#create_post_complete').click(function (e) {
            e.preventDefault()
            var get_value = $('#create_post_input').val()
            var get_fixed = Number(get_value).toFixed(2)
            var current_value = $('#create_post_current_wallet').html()
            var current_fixed = Number(current_value).toFixed(2)
            console.log(get_fixed)
            console.log(current_fixed)
            $('#create_post_note').html('')
            console.log(get_fixed > current_fixed)
            if (parseFloat(get_fixed) > parseFloat(current_fixed)){
                $('#create_post_note').html('more than what you have')
                return false;
            }
            if (parseFloat(get_fixed) < 1){
                $('#create_post_note').html('minimum: 1.00')
                return false;
            }
            $.ajax({
                url:'/re/create/group/post/complete/', type:'post', dataType:'json', cache:false,
                data:{
                    group_id: $('#group_id').html(),
                    gross: get_fixed,
                    text: $.trim($('#create_post_textarea').val())
                },
                success:function (data) {
                    console.log(data)
                    if (data.res === 1){

                    }
                }
            });

        })
            $.ajax({
                url:'/re/create/group/post/', type:'post', dataType:'json', cache:false,
                data:{
                    group_id: $('#group_id').html(),
                },
                success:function (data) {
                    console.log(data)
                    if (data.res === 1){
                        $('#create_post_img').attr('src', data.output.main_photo)
                        $('#create_post_name').html(data.output.main_name)
                        $('#create_post_current_wallet').html(data.output.wallet)

                    }
                }
            });
        $('#create_search_btn').click(function (e) {
            e.preventDefault()
            var keyword = $('#create_search_input').val()

            if (keyword.replace(/ /g,'')==='') {
                return false
            }
            if (keyword.length > 2048) {
                return false
            }
            $('#solo_end').html('false')
            $('#group_end').html('false')
            $('#solo_id').html('')
            $('#group_id').html('')

            $('#keyword').html(keyword)
            $.ajax({
                url:'/re/create/search/', type:'post', dataType:'json', cache:false,
                data:{
                    keyword: keyword,
                    solo_id: $('#solo_id').html(),
                    group_id: $('#group_id').html(),
                    solo_end: $('#solo_end').html(),
                    group_end: $('#group_end').html(),
                },
                success:function (data) {
                    if (data.res === 1){
                        $('#create_search_result').empty()
                        console.log(data)
                        $.each(data.output, function (key, value) {
                            var member = '';
                            $.each(value.member, function (sub_key, sub_value) {
                                member = member + ' ' + sub_value

                            })

                            var appender = $('<a href=""><div class="clickable">' +
                            '<div class="create_search_img_wrapper">' +
                            '<img class="create_search_img" src="' + value.main_photo + '">' +
                            '</div>' +
                            '<div class="create_search_detail_wrapper">' +
                            '<div class="create_search_detail_name">' + value.main_name + '</div>' +
                            '<div class="create_search_detail_explain h5">'+ member +'</div>' +
                            '</div>' +
                            '</div>' +
                            '</a>')
                            $('#create_search_result').append(appender)
                        })


                        if(data.group_end === 'true'){
                            $('#group_end').html('true')
                        }
                        if(data.solo_end === 'true'){
                            $('#solo_end').html('true')
                        }
                        $('#solo_id').html(data.solo_id)
                        $('#group_id').html(data.group_id)
                        if(data.solo_end==='true' && data.group_end ==='true'){
                            if (!($('#create_search_more_load').hasClass('hidden'))){
                               $('#create_search_more_load').addClass('hidden')
                            }
                        } else {
                            if ($('#create_search_more_load').hasClass('hidden')){
                               $('#create_search_more_load').removeClass('hidden')
                            }
                        }

                    }
                }
            });

        })

        $('.modal_reading_form_textarea').on("keypress", function (e) {
            /* ENTER PRESSED*/
            if (e.keyCode == 13 && !e.shiftKey) {

                e.preventDefault()
                    var keyword = $('#create_search_input').val()

                    if (keyword.replace(/ /g,'')==='') {
                        return false
                    }
                    if (keyword.length > 2048) {
                        return false
                    }
                    $('#solo_end').html('false')
                    $('#group_end').html('false')
                    $('#solo_id').html('')
                    $('#group_id').html('')

                    $('#keyword').html(keyword)
                    $.ajax({
                        url:'/re/create/search/', type:'post', dataType:'json', cache:false,
                        data:{
                            keyword: keyword,
                            solo_id: $('#solo_id').html(),
                            group_id: $('#group_id').html(),
                            solo_end: $('#solo_end').html(),
                            group_end: $('#group_end').html(),
                        },
                        success:function (data) {
                            if (data.res === 1){
                                $('#create_search_result').empty()

                                console.log(data)
                                $.each(data.output, function (key, value) {
                                    var member = '';
                                    $.each(value.member, function (sub_key, sub_value) {
                                        member = member + ' ' + sub_value

                                    })

                                    var appender = $('<a href=""><div class="clickable">' +
                                    '<div class="create_search_img_wrapper">' +
                                    '<img class="create_search_img" src="' + value.main_photo + '">' +
                                    '</div>' +
                                    '<div class="create_search_detail_wrapper">' +
                                    '<div class="create_search_detail_name">' + value.main_name + '</div>' +
                                    '<div class="create_search_detail_explain h5">'+ member +'</div>' +
                                    '</div>' +
                                    '</div>' +
                                    '</a>')
                                    $('#create_search_result').append(appender)
                                })


                                if(data.group_end === 'true'){
                                    $('#group_end').html('true')
                                }
                                if(data.solo_end === 'true'){
                                    $('#solo_end').html('true')
                                }
                                $('#solo_id').html(data.solo_id)
                                $('#group_id').html(data.group_id)
                                if(data.solo_end==='true' && data.group_end ==='true'){
                                    if (!($('#create_search_more_load').hasClass('hidden'))){
                                       $('#create_search_more_load').addClass('hidden')
                                    }
                                } else {
                                    if ($('#create_search_more_load').hasClass('hidden')){
                                       $('#create_search_more_load').removeClass('hidden')
                                    }
                                }

                            }
                        }
                    });
                return false;
            }
        })
    });

</script>
</html>